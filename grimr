#!/bin/bash
set -euo pipefail

SERVICE="grimr.service"
AP_NAME="repeater-ap"

status() {
  echo "üîé Grim Repeater status"
  echo ""

  echo "Service:"
  echo "  Enabled: $(systemctl is-enabled $SERVICE 2>/dev/null || echo disabled)"
  echo "  Active:  $(systemctl is-active  $SERVICE 2>/dev/null || echo inactive)"
  echo ""

  # Detect uplink
  UP_IF=$(nmcli -t -f DEVICE,STATE d | awk -F: '$2=="connected"{print $1}' | grep -E 'eth0|wlan0' | head -n1 || true)

  echo "Upstream:"
  if [ "$UP_IF" = "eth0" ]; then
    IP=$(ip -4 addr show eth0 | awk '/inet /{print $2}' | cut -d/ -f1)
    echo "  Interface: eth0 (Ethernet)"
    echo "  IP: ${IP:-none}"
  elif [ "$UP_IF" = "wlan0" ]; then
    SSID=$(iw dev wlan0 link | awk -F'ssid ' '/SSID/{print $2}')
    CH=$(iw dev wlan0 link | awk '/channel/{print $2}')
    echo "  Interface: wlan0 (Wi-Fi)"
    echo "  SSID: ${SSID:-unknown}"
    echo "  Channel: ${CH:-?}"
  else
    echo "  Interface: none"
  fi
  echo ""

  echo "Access Point (broadcast):"
  SSID=$(nmcli -g 802-11-wireless.ssid connection show $AP_NAME 2>/dev/null || echo "unknown")
  BAND=$(nmcli -g 802-11-wireless.band connection show $AP_NAME 2>/dev/null || echo "?")
  CHAN=$(nmcli -g 802-11-wireless.channel connection show $AP_NAME 2>/dev/null || echo "?")
  PASS=$(nmcli -g 802-11-wireless-security.psk connection show $AP_NAME 2>/dev/null || echo "<hidden>")
  echo "  SSID: $SSID"
  echo "  Band: $BAND"
  echo "  Channel: $CHAN"
  echo "  Password: $PASS"
}

case "${1:-}" in
  status) status ;;
  restart) sudo systemctl restart $SERVICE && echo "üîÅ grimr restarted." ;;
  stop) sudo systemctl stop $SERVICE && echo "‚èπÔ∏è  grimr stopped." ;;
  start) sudo systemctl start $SERVICE && echo "‚ñ∂Ô∏è  grimr started." ;;
  logs) journalctl -u $SERVICE -e -n 50 ;;
  *) 
    echo "Usage: grimr {status|start|stop|restart|logs}"
    ;;
esac
